write my full main function given your last recommendations?